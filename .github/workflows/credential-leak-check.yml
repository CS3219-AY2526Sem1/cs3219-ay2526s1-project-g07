# AI Assistance Disclosure:
# Tool: GitHub Copilot (model: claude-sonnet-4.5), date: 2025-11-12
# Scope: Generated GitHub Actions workflow for automatically checking for credential leaks in the repository.
# Author review: I tested the action workflow in GitHub Actions.

name: Credential Leak Check

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  check-credentials:
    runs-on: ubuntu-latest
    name: Check for credential leaks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for PR checks

      - name: Check for Postgres password leak
        id: check_postgres
        run: |
          echo "Checking for Postgres password leaks..."

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, check the entire git history in the PR
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            echo "Checking git history from $BASE_SHA to $HEAD_SHA"

            # Check all commits in the PR, excluding this workflow file
            if git log $BASE_SHA..$HEAD_SHA -p -- . ':!.github/workflows/credential-leak-check.yml' | grep -i "DO_NOT_COMMIT_OR_YOU_WILL_DIE_"; then
              echo "::error::CRITICAL: Postgres password starting with 'DO_NOT_COMMIT_OR_YOU_WILL_DIE_' found in git history!"
              echo "postgres_leak=true" >> $GITHUB_OUTPUT
            else
              echo "No Postgres password leak found in git history"
              echo "postgres_leak=false" >> $GITHUB_OUTPUT
            fi
          else
            # For direct pushes, check current commit, excluding this workflow file
            if git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep -v "^.github/workflows/credential-leak-check.yml$" | xargs grep -l "DO_NOT_COMMIT_OR_YOU_WILL_DIE_" 2>/dev/null; then
              echo "::error::CRITICAL: Postgres password starting with 'DO_NOT_COMMIT_OR_YOU_WILL_DIE_' found in commit!"
              echo "postgres_leak=true" >> $GITHUB_OUTPUT
            else
              echo "No Postgres password leak found"
              echo "postgres_leak=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Check for Gemini API key leak
        id: check_gemini
        run: |
          echo "Checking for Gemini API key leaks..."

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, check the entire git history in the PR
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            echo "Checking git history from $BASE_SHA to $HEAD_SHA"

            # Check all commits in the PR for Gemini API key pattern (starts with AI, ends with nlLU), excluding this workflow file
            if git log $BASE_SHA..$HEAD_SHA -p -- . ':!.github/workflows/credential-leak-check.yml' | grep -E "AI[A-Za-z0-9_-]+nlLU"; then
              echo "::error::CRITICAL: Gemini API key (pattern: AI*nlLU) found in git history!"
              echo "gemini_leak=true" >> $GITHUB_OUTPUT
            else
              echo "No Gemini API key leak found in git history"
              echo "gemini_leak=false" >> $GITHUB_OUTPUT
            fi
          else
            # For direct pushes, check current commit, excluding this workflow file
            if git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep -v "^.github/workflows/credential-leak-check.yml$" | xargs grep -lE "AI[A-Za-z0-9_-]+nlLU" 2>/dev/null; then
              echo "::error::CRITICAL: Gemini API key (pattern: AI*nlLU) found in commit!"
              echo "gemini_leak=true" >> $GITHUB_OUTPUT
            else
              echo "No Gemini API key leak found"
              echo "gemini_leak=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Check entire repository (safety net)
        id: check_repo
        run: |
          echo "Performing full repository scan as safety net..."

          POSTGRES_FOUND=false
          GEMINI_FOUND=false

          # Check for Postgres password in current working tree, excluding this workflow file
          if grep -r "DO_NOT_COMMIT_OR_YOU_WILL_DIE_" --exclude-dir=.git . 2>/dev/null | grep -v "^\\./.github/workflows/credential-leak-check.yml:"; then
            echo "::error::CRITICAL: Postgres password found in repository files!"
            POSTGRES_FOUND=true
          fi

          # Check for Gemini API key in current working tree, excluding this workflow file
          if grep -rE "AI[A-Za-z0-9_-]+nlLU" --exclude-dir=.git --exclude-dir=node_modules . 2>/dev/null | grep -v "^\\./.github/workflows/credential-leak-check.yml:"; then
            echo "::error::CRITICAL: Gemini API key found in repository files!"
            GEMINI_FOUND=true
          fi

          if [ "$POSTGRES_FOUND" = true ] || [ "$GEMINI_FOUND" = true ]; then
            echo "repo_leak=true" >> $GITHUB_OUTPUT
          else
            echo "No credentials found in repository files"
            echo "repo_leak=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if credentials found
        if: steps.check_postgres.outputs.postgres_leak == 'true' || steps.check_gemini.outputs.gemini_leak == 'true' || steps.check_repo.outputs.repo_leak == 'true'
        run: |
          echo "::error::======================================"
          echo "::error::CREDENTIAL LEAK DETECTED!"
          echo "::error::======================================"
          echo "::error::"
          echo "::error::One or more credentials were found in the repository or git history."
          echo "::error::This is a critical security issue that must be resolved immediately."
          echo "::error::"
          echo "::error::If credentials are in git history:"
          echo "::error::1. You must rewrite git history to remove them"
          echo "::error::2. Rotate/regenerate all leaked credentials"
          echo "::error::3. Never commit credentials to version control"
          echo "::error::"
          echo "::error::Use environment variables or secret management instead."
          echo "::error::======================================"
          exit 1

      - name: Success message
        if: steps.check_postgres.outputs.postgres_leak != 'true' && steps.check_gemini.outputs.gemini_leak != 'true' && steps.check_repo.outputs.repo_leak != 'true'
        run: |
          echo "âœ… No credential leaks detected. All checks passed!"
